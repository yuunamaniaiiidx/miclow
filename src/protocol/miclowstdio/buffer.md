# Miclow プロセス→システム プロトコル仕様

## 概要

プロセスからシステムへの通信プロトコルは、以下の2つの形式をサポートします：

1. **1行形式**: `"key": value`
2. **複数行形式**: `"key"::` ... `::"key"`

## プロトコル形式

### 1行形式

```
"key": value
```

- トピック名（`key`）はダブルクォートで囲む
- コロン（`:`）の後に空白を1つ以上入れて値を記述
- 値の前後の空白は許容される

**例:**
```
"topic": hello world
"msg": "value with spaces"
"status": success
```

### 複数行形式

```
"key"::
value line 1
value line 2
...
::"key"
```

- 開始行: `"key"::` （完全一致のみ、追加文字は許容されない）
- 値行: 任意の行数（空行も含む）
- 終了行: `::"key"` （完全一致のみ、追加文字は許容されない）

**例:**
```
"data"::
line 1
line 2
::"data"
```

## パース規則

### 非アクティブ状態（通常状態）

1. **複数行開始の判定を優先**
   - `"key"::` の完全一致を探す
   - 見つかればアクティブ状態に移行

2. **1行形式の判定**
   - 複数行開始が見つからなかった場合
   - `"key": value` 形式を判定
   - 値の前後の空白は許容される

3. **プロトコル形式でない場合**
   - 通常のデータ行として扱う（標準出力に流れる）

### アクティブ状態（複数行受信中）

1. **終了文字の処理**
   - `::"key"` の完全一致を判定
   - トピック名が一致する場合のみ終了してメッセージを送信
   - トピック名が一致しない場合は通常のデータとしてバッファに追加

2. **それ以外は全て通常のデータとして扱う**
   - 間違った終了文字（例: `::"other_key"`）
   - 通常のデータ行
   - これらは全てバッファに追加される（通常のデータとして扱われる）

**例:**
```
"data"::
"""          ← この行は通常のデータとしてバッファに追加される
::"other"    ← この行も通常のデータとしてバッファに追加される（トピック名が一致しない）
hello        ← この行も通常のデータとしてバッファに追加される
::"data"     ← この行で終了し、バッファの内容（"""\n::"other"\nhello\n）が送信される
```

## 制約事項

### 複数行開始

- `"key"::` の完全一致のみ有効
- 追加文字がある場合は無効（例: `"key":: data` は無効）

### 複数行終了

- `::"key"` の完全一致のみ有効
- 追加文字がある場合は無効（例: `::"key" extra` は無効）

### 先頭空白

- 行の先頭に空白（スペースまたはタブ）がある場合、プロトコル形式として認識されない
- 通常のデータ行として扱われる

**例:**
```
  "key"::     ← プロトコル形式として認識されない（NotSpecial）
  ::"key"     ← プロトコル形式として認識されない（NotSpecial）
```

## エスケープ

トピック名内では、バックスラッシュ（`\`）によるエスケープがサポートされます：

- `\"` → ダブルクォート（リテラル）
- `\\` → バックスラッシュ（リテラル）

**例:**
```
"key\"with\"quotes": value
"key\\with\\backslash": value
```

## エラー処理

### parse_quoted_topic の失敗

`parse_quoted_topic` が失敗した場合（例: `"""` のような空のトピック、未終了のクォートなど）、エラーを返さず `NotSpecial` として扱われます。

これにより、プロトコル形式として認識できない行は、通常のデータ行として標準出力に流れます。

## 状態遷移

```
非アクティブ状態
  ↓ "key"::
アクティブ状態（バッファリング中）
  ↓ ::"key"（正しいトピック名）
非アクティブ状態（メッセージ送信）
```

## 実装の詳細

### パース優先順位

1. 複数行開始: `"key"::`
2. 1行形式: `"key": value`
3. 複数行終了: `::"key"`（アクティブ状態中のみ有効）
4. 通常のデータ行（NotSpecial）

### アクティブ状態中の処理

- 終了文字（`::"key"`）で正しいトピック名が指定された場合のみ、バッファの内容を送信してアクティブ状態を終了
- それ以外（間違った終了文字、通常のデータ行など）は全て通常のデータとしてバッファに追加される

