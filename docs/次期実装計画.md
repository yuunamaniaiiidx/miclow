# 次期実装計画

**作成日**: 2025-01-XX  
**最終更新**: 2025-01-XX  
**目的**: システムの次期実装計画を統合的に整理

---

## ⚠️ 重要な注意事項

**本実装計画は破壊的変更を許可しており、後方互換性は維持しません。**

- 既存の API や動作の変更を許容します
- 既存の設定ファイルやクライアントコードの変更が必要になる可能性があります
- 実装の柔軟性と設計の一貫性を優先します

---

## 概要

本システムは、Kubernetes の概念に準拠した内部メッセージングシステムを構築しています。主なコンポーネントは以下の通りです：

- **Pod**: タスクの実行単位
- **ReplicaSetController**: Pod のレプリカ数の管理
- **TopicSubscriptionRegistry**: トピックへの購読者管理とブロードキャスト配信
- **TopicLoadBalancer**: Round Robin 方式でのロードバランシング配信

---

## アーキテクチャの概要

### コンポーネント構成

```
┌─────────────────────────────────────────────────────────┐
│                    MiclowSystem                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────┐    ┌──────────────────────────┐ │
│  │ PodManager       │    │ ReplicaSetController     │ │
│  │ - Pod管理        │    │ - レプリカ数管理         │ │
│  │ - 状態管理       │    │ - 自動補充               │ │
│  └──────────────────┘    └──────────────────────────┘ │
│           │                                              │
│           │                                              │
│  ┌──────────────────┐    ┌──────────────────────────┐ │
│  │ PodSpawner       │    │ TopicSubscriptionRegistry│ │
│  │ - Pod起動        │    │ - 購読者管理             │ │
│  │ - メッセージ転送 │    │ - ブロードキャスト       │ │
│  └──────────────────┘    └──────────────────────────┘ │
│           │                        │                    │
│           │                        │                    │
│           └────────┬───────────────┘                    │
│                    │                                    │
│           ┌────────▼──────────┐                        │
│           │ TopicLoadBalancer │                        │
│           │ - Round Robin配信 │                        │
│           │ - キューイング    │                        │
│           └───────────────────┘                        │
│                    │                                    │
│           ┌────────▼──────────┐                        │
│           │ Pod (Backend)     │                        │
│           │ - タスク実行      │                        │
│           └───────────────────┘                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 命名規則

### 決定された命名

| 旧名称 | 新名称 | 理由 |
|--------|--------|------|
| `task_runtime` | `pod` | Kubernetes の Pod 概念に準拠 |
| `lifecycle` | `replicaset` | Kubernetes の ReplicaSet 概念に準拠 |
| `TaskExecutor` | `PodManager` | Pod の管理を担当 |
| `TaskSpawner` | `PodSpawner` | Pod の起動を担当 |
| `TaskStateManager` | `PodStateManager` | Pod の状態管理を担当 |
| `RunningTask` | `RunningPod` | 実行中の Pod を表現 |
| `StartContext` | `PodStartContext` | Pod 起動時のコンテキスト |
| `LifecycleManager` | `ReplicaSetController` | ReplicaSet の制御を担当 |
| `TopicBroker` | `TopicSubscriptionRegistry` | Pub/Sub の Subscription Registry に準拠 |
| `TopicDispatcher` | `TopicLoadBalancer` | Pub/Sub の Load Balancer に準拠 |
| `MessageQueue` | `TopicQueue` | `message` は `topic` に統一 |

### 命名の原則

1. **Kubernetes 概念への準拠**: Pod、ReplicaSet など、Kubernetes の概念に準拠
2. **Pub/Sub 世界での標準用語**: Subscription Registry、Load Balancer など、メッセージングシステムの標準用語を使用
3. **命名の一貫性**: `message` が付くものは `topic` に統一

---

## コンポーネントの責務

### 1. PodManager

**責務:**
- Pod の登録・削除
- Pod の状態管理へのアクセス提供
- Pod の起動・停止

**実装状況:** ✅ 実装済み

### 2. PodStateManager

**責務:**
- Pod の状態（idle/busy）管理
- Pod 名ごとのインスタンス一覧の管理
- Idle なインスタンスの取得

**実装状況:** ✅ 実装済み（ただし、Round Robin ロジックが含まれている - 要修正）

**修正が必要な点:**
- Round Robin の選択ロジックを `TopicLoadBalancer` に移動
- `round_robin_indices` を `TopicLoadBalancer` で管理

### 3. PodSpawner

**責務:**
- Pod の起動とライフサイクル管理
- Pod からの出力イベント（`ExecutorOutputEvent`）を受信
- メッセージを `TopicSubscriptionRegistry` に転送

**実装状況:** ✅ 実装済み

### 4. ReplicaSetController

**責務:**
- Pod のレプリカ数の管理
- インスタンス数の監視と自動補充
- タスク終了時の即座再起動

**実装状況:** ✅ 実装済み

**注意:** メッセージの流れには直接関与しない（ライフサイクル管理のみ）

### 5. TopicSubscriptionRegistry

**責務:**
- トピックへの購読者管理
- メッセージのブロードキャスト配信
- 最新メッセージの保持
- 購読者リストの提供（タスク名ごとにグループ化）

**実装状況:** ✅ 実装済み（ただし、`TopicLoadBalancer` との統合が未完了）

**修正が必要な点:**
- `TopicLoadBalancer` との統合
- 配信モードの判定ロジック
- タスク名ごとのグループ化機能

### 6. TopicLoadBalancer

**責務:**
- Round Robin 方式でのロードバランシング配信
- タスクの状態（idle/busy）に基づいた配信制御
- メッセージキューイング（すべてのインスタンスが busy の場合）

**実装状況:** ✅ 基盤実装済み（ただし、`TopicSubscriptionRegistry` との統合が未完了）

**修正が必要な点:**
- `TopicSubscriptionRegistry` との統合
- Round Robin の選択ロジックを `PodStateManager` から移動
- キュー処理のトリガー

---

## メッセージの流れ

### 現在の実装（送信フロー）

```
Pod (Backend)
  ↓ ExecutorOutputEvent
PodSpawner
  ↓ broadcast_message()
TopicSubscriptionRegistry
  ↓ 購読者リストに基づいて配信
購読しているPod (複数)
```

**実装状況:** ✅ 実装済み

---

### 理想的な実装（受信フロー）

**ブロードキャストモード:**
```
外部システム
  ↓ メッセージ送信
TopicSubscriptionRegistry
  ↓ publish_message()
  ↓ 購読者リストを取得
  ↓ タスク名ごとにグループ化
  ↓ 配信モードの判定
  ↓ broadcast_message()
購読しているPod (すべて)
```

**Round Robin モード:**
```
外部システム
  ↓ メッセージ送信
TopicSubscriptionRegistry
  ↓ publish_message()
  ↓ 購読者リストを取得
  ↓ タスク名ごとにグループ化
  ↓ 配信モードの判定 (mode = "round_robin")
  ↓ route_to_load_balancer()
TopicLoadBalancer
  ↓ dispatch_message()
  ↓ select_idle_instance_round_robin()
  ↓ Podを選択
Pod (選択されたインスタンス)
  ↓ 処理完了
  ↓ TopicResponse
PodSpawner
  ↓ broadcast_message()
TopicSubscriptionRegistry
  ↓ 返信先に配信
```

**実装状況:** ❌ 未実装

**未実装の機能:**
- 外部からのメッセージ受信のエントリーポイント
- `TopicSubscriptionRegistry` と `TopicLoadBalancer` の統合
- 配信モードの判定ロジック
- タスク名ごとのグループ化機能
- キュー処理のトリガー

---

## 実装計画

### Phase 1: 責務の分離とリファクタリング

**目標:** 各コンポーネントの責務を明確化し、適切な分離を実現

**タスク:**

1. **PodStateManager のリファクタリング**
   - Round Robin の選択ロジックを `TopicLoadBalancer` に移動
   - `round_robin_indices` を `TopicLoadBalancer` で管理
   - `get_idle_instances(pod_name)` のような汎用的なメソッドを提供

2. **コメントの修正**
   - 実装詳細を含まない抽象的な説明に変更
   - 層間の依存関係を明確化

**見積もり:** 1-2日

---

### Phase 2: TopicSubscriptionRegistry と TopicLoadBalancer の統合

**目標:** Round Robin 配信を機能させる

**タスク:**

1. **TopicSubscriptionRegistry の拡張**
   - `get_subscribers_by_task_name()` メソッドの実装
   - タスク名ごとにグループ化する機能
   - 配信モードの判定機能

2. **統合ロジックの実装**
   - `publish_message()` メソッドの実装
   - `route_message()` メソッドの実装
   - Round Robin モードとブロードキャストモードの切り替え

3. **TopicLoadBalancer の統合**
   - `TopicSubscriptionRegistry` から `TopicLoadBalancer` への参照を追加
   - Round Robin 配信の呼び出し

**見積もり:** 2-3日

---

### Phase 3: キュー処理の実装

**目標:** タスクが idle に戻った時にキューに蓄積されたメッセージを処理

**タスク:**

1. **キュー処理のトリガー**
   - タスクが idle 状態に戻った時の検知
   - キュー処理の呼び出し

2. **キュー処理ロジック**
   - タスク名に対応するキューからメッセージを取得
   - Idle なインスタンスに配信
   - キューが空になるか、すべて busy になるまで繰り返し

**見積もり:** 1-2日

---

### Phase 4: 外部メッセージ受信のエントリーポイント

**目標:** システム外部からメッセージを送信できるようにする

**タスク:**

1. **エントリーポイントの実装**
   - `TopicSubscriptionRegistry::publish_message()` の実装
   - 外部システムからのメッセージ受信インターフェース

2. **統合テスト**
   - 外部からのメッセージ送信のテスト
   - Round Robin 配信のテスト
   - ブロードキャスト配信のテスト

**見積もり:** 2-3日

---

## 未実装機能の抽象概念

### 1. メッセージルーティング

**概念:**
- メッセージが `TopicSubscriptionRegistry` に到着した時、購読者リストを取得し、タスク名ごとにグループ化する
- 各タスク名について、配信モード（Round Robin またはブロードキャスト）を判定する
- Round Robin モードの場合は `TopicLoadBalancer` に委譲し、ブロードキャストモードの場合は直接配信する

**実装の方向性:**
- `TopicSubscriptionRegistry` に `route_message()` メソッドを追加
- タスクの設定（`mode = "round_robin"`）に基づいて配信モードを判定
- `TopicLoadBalancer` への参照を保持し、必要に応じて委譲

---

### 2. 配信モードの判定

**概念:**
- タスクの設定（`lifecycle.mode`）に基づいて配信モードを判定する
- `mode = "round_robin"` の場合は Round Robin 配信
- それ以外の場合はブロードキャスト配信

**実装の方向性:**
- `TopicSubscriptionRegistry` に `is_round_robin_mode(task_name)` メソッドを追加
- タスクの設定情報へのアクセスが必要（`SystemConfig` への参照など）

---

### 3. タスク名ごとのグループ化

**概念:**
- トピックを購読している購読者リストを、タスク名ごとにグループ化する
- タスクIDからタスク名を取得し、タスク名をキーとしてグループ化する

**実装の方向性:**
- `TopicSubscriptionRegistry` に `group_subscribers_by_task_name()` メソッドを追加
- `PodManager` への参照が必要（タスクIDからタスク名を取得するため）

---

### 4. キュー処理のトリガー

**概念:**
- タスクが idle 状態に戻った時、そのタスク名に対応するキューに蓄積されたメッセージを処理する
- TopicResponse 受信時やタスク登録時など、適切なタイミングでキュー処理をトリガーする

**実装の方向性:**
- `PodSpawner` で TopicResponse 受信時に `TopicLoadBalancer::process_queue()` を呼び出す
- `TopicLoadBalancer` に `process_queue(task_name)` メソッドを実装

---

## 設定例

```toml
[[tasks]]
protocol = "MiclowStdIO"
task_name = "worker"
command = "uv"
args = ["run", "python3", "worker.py"]
subscribe_topics = ["work.queue", "work.priority"]

  [[tasks.lifecycle]]
  desired_instances = 3
  mode = "round_robin"
```

この設定により、`worker` タスクは3つのインスタンスが常駐し、`subscribe_topics` で指定されたトピック（"work.queue" と "work.priority"）のメッセージが、3つのインスタンス間で Round Robin 方式で配信される。

---

## 実装の優先順位

### 🔴 優先度: 高（必須）

1. **PodStateManager のリファクタリング**
   - Round Robin ロジックの移動
   - 責務の明確化

2. **TopicSubscriptionRegistry と TopicLoadBalancer の統合**
   - 配信モードの判定
   - タスク名ごとのグループ化
   - Round Robin 配信の統合

3. **キュー処理の実装**
   - キュー処理のトリガー
   - キューからのメッセージ配信

### 🟡 優先度: 中（推奨）

4. **外部メッセージ受信のエントリーポイント**
   - `publish_message()` の実装
   - 外部システムとの統合

5. **エラーハンドリングの強化**
   - Round Robin 配信失敗時のリトライ
   - キュー処理失敗時のログ出力と監視

### 🟢 優先度: 低（将来）

6. **パフォーマンス最適化**
   - キュー処理のバッチ化
   - マッピングのキャッシュ最適化

7. **他のロードバランシング方式の追加**
   - Least Connections
   - Weighted Round Robin

---

## 技術的な詳細

### Round Robin 配信の動作フロー（抽象概念）

```
1. メッセージが TopicSubscriptionRegistry に到着
2. 購読者リストを取得
3. タスク名ごとにグループ化
4. 各タスク名について:
   a. タスクの lifecycle 設定を確認
   b. mode = "round_robin" の場合:
      - TopicLoadBalancer::dispatch_message を呼び出す
      - Idle なインスタンスを選択（Round Robin 方式）
      - メッセージを送信し、タスクを busy に設定
      - すべて busy の場合はキューに追加
   c. 通常モードの場合:
      - そのタスク名の全インスタンスに配信
5. .result トピックの場合:
   a. 既存の broadcast_message を使用（全サブスクライバーに配信）
```

---

### キュー処理の動作フロー（抽象概念）

```
1. タスクが TopicResponse を返す
2. PodSpawner で TopicResponse を受信
3. タスクを idle に戻す
4. TopicLoadBalancer::process_queue(task_name) を呼び出す
5. タスク名から subscribe_topics を取得
6. 各トピックについて、キューにメッセージがある場合:
   a. Idle なインスタンスを選択（Round Robin 方式）
   b. メッセージを送信し、タスクを busy に設定
   c. キューが空になるか、すべて busy になるまで繰り返し
```

---

## 関連ファイル

### 実装済み

- `src/pod/manager.rs` - PodManager の実装
- `src/pod/state.rs` - PodStateManager の実装
- `src/pod/spawner.rs` - PodSpawner の実装
- `src/pod/context.rs` - PodStartContext の実装
- `src/replicaset/controller.rs` - ReplicaSetController の実装
- `src/topic_subscription_registry.rs` - TopicSubscriptionRegistry の実装
- `src/topic_load_balancer/balancer.rs` - TopicLoadBalancer の実装

### 修正が必要

- `src/pod/state.rs` - Round Robin ロジックの移動
- `src/topic_subscription_registry.rs` - TopicLoadBalancer との統合
- `src/topic_load_balancer/balancer.rs` - Round Robin ロジックの実装

---

## 注意事項

1. **破壊的変更の許可**: 本実装計画は破壊的変更を許可しており、後方互換性は維持しません。既存の API や動作の変更を許容します。

2. **パフォーマンス**: Round Robin 配信は追加のオーバーヘッドがあるため、必要な場合のみ使用することを推奨します。

3. **エラーハンドリング**: Round Robin 配信失敗時はキューに追加し、後でリトライする仕組みを実装することを推奨します。

4. **テスト**: Round Robin 配信の動作を確認する統合テストが必要です。

---

## 関連ドキュメント

- `docs/task_lifecycle_implementation_plan.md` - タスクライフサイクルの実装計画（詳細）
- `docs/rename_inconsistencies.md` - リネーム後の不整合内容
- `docs/topic_broker_responsibilities.md` - TopicSubscriptionRegistry の責務整理
- `docs/pubsub_naming_recommendations.md` - Pub/Sub 世界での命名推奨
- `docs/message_flow.md` - メッセージの流れの詳細

---

## 更新履歴

- 2025-01-XX: 初版作成（docs配下のドキュメントを統合）

